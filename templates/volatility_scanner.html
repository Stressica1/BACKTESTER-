<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Advanced Volatility Scanner - Bitget USDT-M Pairs</title>
    
    <!-- Modern UI Libraries -->
    <link href="https://cdn.jsdelivr.net/npm/@mdi/font@7.2.96/css/materialdesignicons.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/ag-grid-community@30.0.0/styles/ag-grid.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/ag-grid-community@30.0.0/styles/ag-theme-alpine-dark.css" rel="stylesheet">
    
    <!-- Material Design Components -->
    <link href="https://unpkg.com/material-components-web@latest/dist/material-components-web.min.css" rel="stylesheet">
    <script src="https://unpkg.com/material-components-web@latest/dist/material-components-web.min.js"></script>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    
    <!-- JS Libraries -->
    <script src="https://cdn.jsdelivr.net/npm/ag-grid-community@30.0.0/dist/ag-grid-community.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.3.0/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/apexcharts@3.41.0/dist/apexcharts.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/d3@7.8.5/dist/d3.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <style>
        :root {
            /* Futuristic neon color scheme */
            --mdc-theme-primary: #00f5d4;
            --mdc-theme-secondary: #00bbf9;
            --mdc-theme-tertiary: #9b5de5;
            --mdc-theme-success: #00f5a0;
            --mdc-theme-warning: #fee440;
            --mdc-theme-danger: #f15bb5;
            --mdc-theme-info: #00c3ff;
            
            /* Deep space dark mode */
            --mdc-theme-background: #05070f;
            --mdc-theme-surface: #0f1729;
            --mdc-theme-surface-variant: #192338;
            --mdc-theme-surface-elevated: #232e47;
            
            /* Text colors */
            --mdc-theme-on-primary: #ffffff;
            --mdc-theme-on-secondary: #ffffff;
            --mdc-theme-on-surface: #f8fafc;
            --mdc-theme-on-background: #f8fafc;
            --mdc-theme-text-primary: rgba(248, 250, 252, 0.95);
            --mdc-theme-text-secondary: rgba(248, 250, 252, 0.75);
            --mdc-theme-text-hint: rgba(248, 250, 252, 0.5);
            --mdc-theme-text-disabled: rgba(248, 250, 252, 0.38);
            --mdc-theme-divider: rgba(248, 250, 252, 0.1);
        }

        body {
            margin: 0;
            padding: 0;
            background-color: var(--mdc-theme-background);
            color: var(--mdc-theme-on-background);
            font-family: 'Roboto', sans-serif;
            min-height: 100vh;
        }

        header {
            background-color: var(--mdc-theme-surface);
            padding: 1rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .header-title {
            font-size: 1.5rem;
            font-weight: 500;
            display: flex;
            align-items: center;
        }

        .header-title i {
            margin-right: 10px;
            color: var(--mdc-theme-primary);
        }
        
        .controls {
            background-color: var(--mdc-theme-surface);
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
        }
        
        .control-group {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin: 0.5rem 0;
        }
        
        .timeframe-selector {
            display: flex;
            gap: 0.5rem;
        }
        
        .timeframe-btn {
            padding: 0.5rem 1rem;
            border: 1px solid var(--mdc-theme-divider);
            background-color: var(--mdc-theme-surface-variant);
            color: var(--mdc-theme-text-primary);
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .timeframe-btn.active {
            background-color: var(--mdc-theme-primary);
            color: var(--mdc-theme-on-primary);
            border-color: var(--mdc-theme-primary);
        }
        
        .loading-indicator {
            display: none;
            align-items: center;
            gap: 0.5rem;
            color: var(--mdc-theme-info);
        }
        
        .spinner {
            width: 20px;
            height: 20px;
            border: 2px solid rgba(0, 195, 255, 0.3);
            border-radius: 50%;
            border-top-color: var(--mdc-theme-info);
            animation: spin 1s infinite linear;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .grid-container {
            height: 650px;
            width: 100%;
            background-color: var(--mdc-theme-surface);
            border-radius: 8px;
        }
        
        .refresh-button {
            background-color: var(--mdc-theme-primary);
            color: var(--mdc-theme-on-primary);
            border: none;
            border-radius: 4px;
            padding: 0.5rem 1rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            transition: all 0.3s;
        }
        
        .refresh-button:hover {
            background-color: rgba(0, 245, 212, 0.8);
        }
        
        .last-updated {
            color: var(--mdc-theme-text-secondary);
            font-size: 0.875rem;
            margin-top: 0.5rem;
        }
        
        .metric-card {
            background-color: var(--mdc-theme-surface-variant);
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        
        .metric-title {
            font-size: 0.875rem;
            color: var(--mdc-theme-text-secondary);
            margin-bottom: 0.5rem;
        }
        
        .metric-value {
            font-size: 1.5rem;
            font-weight: 500;
            color: var(--mdc-theme-primary);
        }
        
        .metric-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 1rem;
            margin-top: 1rem;
        }
        
        .appeal-score-cell {
            position: relative;
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
        }
        
        .appeal-score-bar {
            height: 8px;
            background: linear-gradient(to right, #f15bb5, #fee440, #00f5a0);
            border-radius: 4px;
            position: absolute;
            bottom: 5px;
            left: 0;
        }
        
        .appeal-score-value {
            font-weight: 500;
        }
        
        .volatility-cell {
            font-weight: 500;
        }
        
        .positive-change {
            color: var(--mdc-theme-success);
        }
        
        .negative-change {
            color: var(--mdc-theme-danger);
        }
        
        @media (max-width: 768px) {
            .controls {
                flex-direction: column;
                align-items: flex-start;
            }
            
            .control-group {
                width: 100%;
                margin: 0.5rem 0;
            }
            
            .grid-container {
                height: 500px;
            }
        }
    </style>
</head>
<body>
    <header>        <div class="header-title">
            <i class="material-icons">trending_up</i>
            <span>Bitget USDT-M Volatility Scanner</span>
        </div>
        <a href="/" class="mdc-button">
            <span class="mdc-button__ripple"></span>
            <i class="material-icons mdc-button__icon">dashboard</i>
            <span class="mdc-button__label">Dashboard</span>
        </a>
    </header>
    
    <div class="container">
        <div class="controls">
            <div class="control-group">
                <label>Timeframe:</label>
                <div class="timeframe-selector">
                    <button class="timeframe-btn" data-timeframe="1h">1H</button>
                    <button class="timeframe-btn active" data-timeframe="4h">4H</button>
                    <button class="timeframe-btn" data-timeframe="1d">1D</button>
                </div>
            </div>
            
            <div class="control-group">
                <label>Top coins:</label>
                <select id="topCoinsSelect" class="mdc-select">
                    <option value="10">Top 10</option>
                    <option value="20" selected>Top 20</option>
                    <option value="30">Top 30</option>
                    <option value="50">Top 50</option>
                </select>
                
                <button id="refreshButton" class="refresh-button">
                    <i class="material-icons">refresh</i>
                    <span>Refresh</span>
                </button>
                
                <div class="loading-indicator" id="loadingIndicator">
                    <div class="spinner"></div>
                    <span>Loading...</span>
                </div>
            </div>
        </div>
        
        <div class="metric-grid">
            <div class="metric-card">
                <div class="metric-title">Most Volatile</div>
                <div class="metric-value" id="mostVolatileCoin">-</div>
            </div>
            <div class="metric-card">
                <div class="metric-title">Highest Appeal Score</div>
                <div class="metric-value" id="highestAppealCoin">-</div>
            </div>
            <div class="metric-card">
                <div class="metric-title">Best 24h Change</div>
                <div class="metric-value" id="bestPerformer">-</div>
            </div>
            <div class="metric-card">
                <div class="metric-title">Largest Price Range</div>
                <div class="metric-value" id="largestRange">-</div>
            </div>
        </div>
        
        <div class="last-updated" id="lastUpdated">Last updated: -</div>
        
        <div class="mdc-tab-bar" role="tablist">
            <div class="mdc-tab-scroller">
                <div class="mdc-tab-scroller__scroll-area">
                    <div class="mdc-tab-scroller__scroll-content">
                        <button class="mdc-tab mdc-tab--active" role="tab" aria-selected="true" tabindex="0" id="grid-tab">
                            <span class="mdc-tab__content">
                                <span class="mdc-tab__icon material-icons">table_chart</span>
                                <span class="mdc-tab__text-label">Table View</span>
                            </span>
                            <span class="mdc-tab-indicator mdc-tab-indicator--active">
                                <span class="mdc-tab-indicator__content mdc-tab-indicator__content--underline"></span>
                            </span>
                            <span class="mdc-tab__ripple"></span>
                        </button>
                        <button class="mdc-tab" role="tab" aria-selected="false" tabindex="-1" id="heatmap-tab">
                            <span class="mdc-tab__content">
                                <span class="mdc-tab__icon material-icons">grid_on</span>
                                <span class="mdc-tab__text-label">Heatmap</span>
                            </span>
                            <span class="mdc-tab-indicator">
                                <span class="mdc-tab-indicator__content mdc-tab-indicator__content--underline"></span>
                            </span>
                            <span class="mdc-tab__ripple"></span>
                        </button>
                        <button class="mdc-tab" role="tab" aria-selected="false" tabindex="-1" id="metrics-tab">
                            <span class="mdc-tab__content">
                                <span class="mdc-tab__icon material-icons">analytics</span>
                                <span class="mdc-tab__text-label">Advanced Metrics</span>
                            </span>
                            <span class="mdc-tab-indicator">
                                <span class="mdc-tab-indicator__content mdc-tab-indicator__content--underline"></span>
                            </span>
                            <span class="mdc-tab__ripple"></span>
                        </button>
                        <button class="mdc-tab" role="tab" aria-selected="false" tabindex="-1" id="portfolios-tab">
                            <span class="mdc-tab__content">
                                <span class="mdc-tab__icon material-icons">pie_chart</span>
                                <span class="mdc-tab__text-label">Portfolio Simulator</span>
                            </span>
                            <span class="mdc-tab-indicator">
                                <span class="mdc-tab-indicator__content mdc-tab-indicator__content--underline"></span>
                            </span>
                            <span class="mdc-tab__ripple"></span>
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <div class="tab-content">
            <div id="grid-view" class="tab-pane active">
                <div id="volatilityGrid" class="ag-theme-alpine-dark grid-container"></div>
            </div>
            
            <div id="heatmap-view" class="tab-pane">
                <div class="heatmap-controls">
                    <div class="control-group">
                        <label>Heatmap Metric:</label>
                        <select id="heatmapMetricSelect" class="mdc-select">
                            <option value="appeal_score">Appeal Score</option>
                            <option value="daily_volatility">Volatility %</option>
                            <option value="atr_pct">ATR %</option>
                            <option value="rsi">RSI</option>
                            <option value="volume_change_pct">Volume Change %</option>
                            <option value="bb_squeeze">Bollinger Squeeze</option>
                            <option value="mean_reversion_score">Mean Reversion Score</option>
                        </select>
                    </div>
                </div>
                <div id="heatmapContainer" class="heatmap-container"></div>
            </div>
            
            <div id="metrics-view" class="tab-pane">
                <div class="metrics-controls">
                    <div class="control-group">
                        <label>Select Coin:</label>
                        <select id="detailedCoinSelect" class="mdc-select"></select>
                    </div>
                </div>
                <div class="metrics-grid">
                    <div class="metric-card">
                        <div class="metric-title">Volatility Analysis</div>
                        <div id="volatilityGauge" class="gauge-chart"></div>
                        <div class="metric-details">
                            <div class="detail-item">
                                <span>Daily Vol:</span>
                                <span id="detailDailyVol">-</span>
                            </div>
                            <div class="detail-item">
                                <span>ATR %:</span>
                                <span id="detailAtr">-</span>
                            </div>
                            <div class="detail-item">
                                <span>BB Width:</span>
                                <span id="detailBbWidth">-</span>
                            </div>
                            <div class="detail-item">
                                <span>Vol Regime:</span>
                                <span id="detailVolRegime">-</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="metric-card">
                        <div class="metric-title">Mean Reversion Potential</div>
                        <div id="meanReversionGauge" class="gauge-chart"></div>
                        <div class="metric-details">
                            <div class="detail-item">
                                <span>Z-Score:</span>
                                <span id="detailZScore">-</span>
                            </div>
                            <div class="detail-item">
                                <span>Direction:</span>
                                <span id="detailMrDirection">-</span>
                            </div>
                            <div class="detail-item">
                                <span>Stationarity:</span>
                                <span id="detailStationarity">-</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="metric-card">
                        <div class="metric-title">Volume Analysis</div>
                        <div id="volumeChart" class="chart"></div>
                        <div class="metric-details">
                            <div class="detail-item">
                                <span>Rel Volume:</span>
                                <span id="detailRelVolume">-</span>
                            </div>
                            <div class="detail-item">
                                <span>Vol Change:</span>
                                <span id="detailVolChange">-</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="metric-card">
                        <div class="metric-title">Technical Indicators</div>
                        <div id="technicalChart" class="chart"></div>
                        <div class="metric-details">
                            <div class="detail-item">
                                <span>RSI:</span>
                                <span id="detailRsi">-</span>
                            </div>
                            <div class="detail-item">
                                <span>MACD:</span>
                                <span id="detailMacd">-</span>
                            </div>
                            <div class="detail-item">
                                <span>Trend Strength:</span>
                                <span id="detailTrend">-</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div id="portfolios-view" class="tab-pane">
                <div class="portfolio-controls">
                    <div class="control-group">
                        <label>Portfolio Type:</label>
                        <div class="portfolio-type-selector">
                            <button class="portfolio-type-btn active" data-type="highVol">High Volatility</button>
                            <button class="portfolio-type-btn" data-type="meanReversion">Mean Reversion</button>
                            <button class="portfolio-type-btn" data-type="momentum">Momentum</button>
                            <button class="portfolio-type-btn" data-type="balanced">Balanced</button>
                            <button class="portfolio-type-btn" data-type="custom">Custom</button>
                        </div>
                    </div>
                    
                    <div class="control-group">
                        <label>Initial Capital:</label>
                        <input type="number" id="initialCapital" value="10000" class="mdc-text-field" />
                        <label>Portfolio Size:</label>
                        <select id="portfolioSize" class="mdc-select">
                            <option value="3">3 Coins</option>
                            <option value="5" selected>5 Coins</option>
                            <option value="10">10 Coins</option>
                        </select>
                        <button id="simulatePortfolioBtn" class="mdc-button mdc-button--raised">
                            <span class="mdc-button__label">Simulate Portfolio</span>
                        </button>
                    </div>
                </div>
                
                <div class="portfolio-results">
                    <div class="portfolio-composition-card">
                        <h3>Portfolio Composition</h3>
                        <div id="portfolioPieChart" class="pie-chart"></div>
                    </div>
                    
                    <div class="portfolio-metrics-card">
                        <h3>Portfolio Metrics</h3>
                        <div class="portfolio-metrics">
                            <div class="portfolio-metric">
                                <span class="metric-name">Expected Return:</span>
                                <span class="metric-value" id="expectedReturn">-</span>
                            </div>
                            <div class="portfolio-metric">
                                <span class="metric-name">Volatility:</span>
                                <span class="metric-value" id="portfolioVolatility">-</span>
                            </div>
                            <div class="portfolio-metric">
                                <span class="metric-name">Sharpe Ratio:</span>
                                <span class="metric-value" id="sharpeRatio">-</span>
                            </div>
                            <div class="portfolio-metric">
                                <span class="metric-name">Max Drawdown:</span>
                                <span class="metric-value" id="maxDrawdown">-</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="portfolio-assets-card">
                        <h3>Portfolio Assets</h3>
                        <div id="portfolioAssetsGrid" class="mini-grid"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize variables
            let currentTimeframe = '4h';
            let topN = 20;
            let gridApi = null;
            let currentData = [];
            
            // Initialize grid
            initializeGrid();
            
            // Load initial data
            loadVolatilityData();
            
            // Set up event listeners
            setupEventListeners();
            
            // Initialize tab functionality
            setupTabs();
            setupAdvancedViews();
            setupRealTimeUpdates();
            
            function setupEventListeners() {
                // Timeframe buttons
                document.querySelectorAll('.timeframe-btn').forEach(button => {
                    button.addEventListener('click', function() {
                        // Update active state
                        document.querySelectorAll('.timeframe-btn').forEach(btn => {
                            btn.classList.remove('active');
                        });
                        this.classList.add('active');
                        
                        // Update timeframe and reload data
                        currentTimeframe = this.getAttribute('data-timeframe');
                        loadVolatilityData();
                    });
                });
                
                // Top coins select
                document.getElementById('topCoinsSelect').addEventListener('change', function() {
                    topN = parseInt(this.value);
                    loadVolatilityData();
                });
                
                // Refresh button
                document.getElementById('refreshButton').addEventListener('click', function() {
                    loadVolatilityData();
                });
            }
            
            function setupTabs() {
                const tabs = document.querySelectorAll('.mdc-tab');
                const tabPanes = document.querySelectorAll('.tab-pane');
                
                tabs.forEach(tab => {
                    tab.addEventListener('click', function() {
                        // Update active tab
                        tabs.forEach(t => {
                            t.classList.remove('mdc-tab--active');
                            t.setAttribute('aria-selected', 'false');
                            t.querySelector('.mdc-tab-indicator').classList.remove('mdc-tab-indicator--active');
                        });
                        
                        this.classList.add('mdc-tab--active');
                        this.setAttribute('aria-selected', 'true');
                        this.querySelector('.mdc-tab-indicator').classList.add('mdc-tab-indicator--active');
                        
                        // Show corresponding tab pane
                        const tabId = this.id;
                        const viewId = tabId.replace('-tab', '-view');
                        
                        tabPanes.forEach(pane => {
                            pane.classList.remove('active');
                        });
                        
                        document.getElementById(viewId).classList.add('active');
                        
                        // Initialize view-specific content if needed
                        if (tabId === 'heatmap-tab') {
                            initHeatmap();
                        } else if (tabId === 'metrics-tab') {
                            updateMetricsView();
                        } else if (tabId === 'portfolios-tab') {
                            initPortfolioSimulator();
                        }
                    });
                });
            }
            
            function initializeGrid() {
                const gridOptions = {
                    columnDefs: [
                        { 
                            headerName: 'Symbol', 
                            field: 'symbol',
                            pinned: 'left',
                            sortable: true,
                            filter: true,
                            width: 120,
                            cellRenderer: function(params) {
                                const symbol = params.value.replace(':USDT', '');
                                return `<div class="flex items-center">
                                    <strong>${symbol}</strong>
                                </div>`;
                            }
                        },
                        { 
                            headerName: 'Appeal Score', 
                            field: 'appeal_score',
                            sortable: true,
                            sort: 'desc',
                            width: 130,
                            cellRenderer: function(params) {
                                const score = params.value;
                                const width = Math.min(100, score * 100) + '%';
                                return `<div class="appeal-score-cell">
                                    <span class="appeal-score-value">${score.toFixed(2)}</span>
                                    <div class="appeal-score-bar" style="width: ${width}"></div>
                                </div>`;
                            }
                        },
                        { 
                            headerName: 'Last Price', 
                            field: 'last_price',
                            sortable: true,
                            width: 110,
                            valueFormatter: function(params) {
                                if (params.value > 1000) {
                                    return '$' + params.value.toFixed(1);
                                } else if (params.value > 1) {
                                    return '$' + params.value.toFixed(2);
                                } else if (params.value > 0.1) {
                                    return '$' + params.value.toFixed(3);
                                } else {
                                    return '$' + params.value.toFixed(6);
                                }
                            }
                        },
                        { 
                            headerName: 'Daily Vol %', 
                            field: 'daily_volatility',
                            sortable: true,
                            width: 110,
                            cellRenderer: function(params) {
                                return `<div class="volatility-cell">
                                    ${params.value.toFixed(2)}%
                                </div>`;
                            }
                        },
                        { 
                            headerName: 'ATR %', 
                            field: 'atr_pct',
                            sortable: true,
                            width: 90,
                            valueFormatter: function(params) {
                                return params.value.toFixed(2) + '%';
                            }
                        },
                        { 
                            headerName: 'RSI', 
                            field: 'rsi',
                            sortable: true,
                            width: 80,
                            cellRenderer: function(params) {
                                let color = 'inherit';
                                if (params.value > 70) color = 'var(--mdc-theme-success)';
                                if (params.value < 30) color = 'var(--mdc-theme-danger)';
                                
                                return `<div style="color: ${color}">
                                    ${params.value.toFixed(1)}
                                </div>`;
                            }
                        },
                        { 
                            headerName: 'BB Squeeze', 
                            field: 'bb_squeeze',
                            sortable: true,
                            width: 110,
                            cellRenderer: function(params) {
                                const value = params.value;
                                const width = Math.min(100, value * 100) + '%';
                                
                                return `<div class="squeeze-cell">
                                    <div class="squeeze-bar" style="width: ${width}; background: ${value > 0.7 ? 'var(--mdc-theme-warning)' : 'var(--mdc-theme-info)'}"></div>
                                    <span>${(value * 100).toFixed(0)}%</span>
                                </div>`;
                            }
                        },
                        { 
                            headerName: 'Mean Rev', 
                            field: 'mean_reversion_score',
                            sortable: true,
                            width: 100,
                            cellRenderer: function(params) {
                                const value = params.value;
                                const direction = params.data.mean_reversion_direction;
                                const directionIcon = direction > 0 ? '↑' : direction < 0 ? '↓' : '→';
                                const color = direction > 0 ? 'var(--mdc-theme-success)' : 
                                             direction < 0 ? 'var(--mdc-theme-danger)' : 'inherit';
                                
                                return `<div class="mean-rev-cell">
                                    ${(value * 100).toFixed(0)}% <span style="color: ${color}">${directionIcon}</span>
                                </div>`;
                            }
                        },
                        { 
                            headerName: 'Vol Regime', 
                            field: 'volatility_regime',
                            sortable: true,
                            width: 120,
                            cellRenderer: function(params) {
                                const regime = params.value;
                                let color;
                                
                                switch(regime) {
                                    case 'low': color = '#4caf50'; break;
                                    case 'medium': color = '#2196f3'; break;
                                    case 'high': color = '#ff9800'; break;
                                    case 'extreme': color = '#f44336'; break;
                                    default: color = '#9e9e9e';
                                }
                                
                                return `<div class="regime-cell" style="color: ${color}">
                                    ${regime.charAt(0).toUpperCase() + regime.slice(1)}
                                </div>`;
                            }
                        },
                        { 
                            headerName: '1d Change', 
                            field: '1d_change',
                            sortable: true,
                            width: 110,
                            cellRenderer: function(params) {
                                if (!params.value && params.value !== 0) return '-';
                                const isPositive = params.value >= 0;
                                const colorClass = isPositive ? 'positive-change' : 'negative-change';
                                const sign = isPositive ? '+' : '';
                                return `<div class="${colorClass}">
                                    ${sign}${params.value.toFixed(2)}%
                                </div>`;
                            }
                        },
                        { 
                            headerName: 'Vol Change', 
                            field: 'volume_change_pct',
                            sortable: true,
                            width: 110,
                            cellRenderer: function(params) {
                                const isPositive = params.value >= 0;
                                const colorClass = isPositive ? 'positive-change' : 'negative-change';
                                const sign = isPositive ? '+' : '';
                                return `<div class="${colorClass}">
                                    ${sign}${params.value.toFixed(2)}%
                                </div>`;
                            }
                        },
                        { 
                            headerName: 'Actions', 
                            field: 'symbol',
                            width: 200,
                            cellRenderer: function(params) {
                                const symbol = params.value.replace(':USDT', '').replace('/', '');
                                return `
                                    <div class="flex space-x-2">
                                        <button class="action-btn trade-btn" data-symbol="${symbol}">
                                            <i class="material-icons">trending_up</i>
                                            <span>Trade</span>
                                        </button>
                                        <button class="action-btn alert-btn" data-symbol="${symbol}">
                                            <i class="material-icons">notifications</i>
                                        </button>
                                        <button class="action-btn analyze-btn" data-symbol="${symbol}">
                                            <i class="material-icons">analytics</i>
                                        </button>
                                    </div>
                                `;
                            }
                        }
                    ],
                    defaultColDef: {
                        flex: 1,
                        minWidth: 80,
                        resizable: true
                    },
                    rowData: [],
                    pagination: true,
                    paginationPageSize: 25,
                    domLayout: 'autoHeight',
                    animateRows: true,
                    enableCellTextSelection: true,
                    onGridReady: function(params) {
                        gridApi = params.api;
                        params.api.sizeColumnsToFit();
                        
                        // Add event listener for row clicks
                        params.api.addEventListener('cellClicked', function(event) {
                            if (event.column.colId === 'symbol') {
                                // When clicking on symbol, select for detailed view
                                const symbol = event.value;
                                updateDetailedView(symbol);
                            } else if (event.column.colId === 'appeal_score') {
                                // Show appeal score breakdown
                                showAppealScoreBreakdown(event.data);
                            }
                              // Handle action buttons
                            if (event.column.colId === 'symbol') {
                                if (event.event.target.closest('.trade-btn')) {
                                    const symbol = event.event.target.closest('.trade-btn').dataset.symbol;
                                    window.open(`https://www.bitget.com/spot/${symbol}`, '_blank');
                                } else if (event.event.target.closest('.alert-btn')) {
                                    const symbol = event.event.target.closest('.alert-btn').dataset.symbol;
                                    setupPriceAlert(symbol);
                                } else if (event.event.target.closest('.analyze-btn')) {
                                    const symbol = event.event.target.closest('.analyze-btn').dataset.symbol;
                                    showDetailedAnalysis(symbol);
                                }
                            }
                        });
                    },
                    onFirstDataRendered: function(params) {
                        params.api.sizeColumnsToFit();
                    }
                };
                
                const gridDiv = document.getElementById('volatilityGrid');
                new agGrid.Grid(gridDiv, gridOptions);
                
                return gridOptions;
            }
            
            function loadVolatilityData() {
                // Show loading indicator
                const loadingIndicator = document.getElementById('loadingIndicator');
                loadingIndicator.style.display = 'flex';
                
                // Clear previous data
                if (gridApi) {
                    gridApi.setRowData([]);
                }
                
                // Clear metrics
                document.getElementById('mostVolatileCoin').textContent = '-';
                document.getElementById('highestAppealCoin').textContent = '-';
                document.getElementById('bestPerformer').textContent = '-';
                document.getElementById('largestRange').textContent = '-';
                
                // Fetch data from API
                fetch(`/api/volatile-coins?timeframe=${currentTimeframe}&top_n=${topN}`)
                    .then(response => response.json())
                    .then(data => {
                        // Hide loading indicator
                        loadingIndicator.style.display = 'none';
                        
                        if (data.success && data.data && data.data.length > 0) {
                            // Store current data
                            currentData = data.data;
                            
                            // Update grid
                            if (gridApi) {
                                gridApi.setRowData(data.data);
                            }
                            
                            // Update last updated time
                            const lastUpdated = new Date(data.timestamp);
                            document.getElementById('lastUpdated').textContent = 
                                `Last updated: ${lastUpdated.toLocaleString()}`;
                            
                            // Update metrics
                            updateMetrics(data.data);
                        } else {
                            console.error('No data returned from API');
                            alert('Error loading volatility data. Please try again later.');
                        }
                    })
                    .catch(error => {
                        // Hide loading indicator
                        loadingIndicator.style.display = 'none';
                        
                        console.error('Error fetching volatility data:', error);
                        alert('Error loading volatility data. Please try again later.');
                    });
            }
            
            function updateMetrics(data) {
                if (!data || data.length === 0) return;
                
                // Most volatile coin (highest volatility)
                const mostVolatile = [...data].sort((a, b) => b.volatility - a.volatility)[0];
                document.getElementById('mostVolatileCoin').textContent = 
                    `${mostVolatile.symbol.replace(':USDT', '')} (${mostVolatile.volatility.toFixed(2)}%)`;
                
                // Highest appeal score
                const highestAppeal = [...data].sort((a, b) => b.appeal_score - a.appeal_score)[0];
                document.getElementById('highestAppealCoin').textContent = 
                    `${highestAppeal.symbol.replace(':USDT', '')} (${highestAppeal.appeal_score.toFixed(2)})`;
                
                // Best 1-day performer
                const performers = [...data].filter(coin => coin['1d_change'] !== undefined)
                    .sort((a, b) => b['1d_change'] - a['1d_change']);
                
                if (performers.length > 0) {
                    const bestPerformer = performers[0];
                    document.getElementById('bestPerformer').textContent = 
                        `${bestPerformer.symbol.replace(':USDT', '')} (+${bestPerformer['1d_change'].toFixed(2)}%)`;
                }
                
                // Largest range
                const largestRange = [...data].sort((a, b) => b.latest_range_pct - a.latest_range_pct)[0];
                document.getElementById('largestRange').textContent = 
                    `${largestRange.symbol.replace(':USDT', '')} (${largestRange.latest_range_pct.toFixed(2)}%)`;
            }
            
            function initHeatmap() {
                if (!currentData || currentData.length === 0) return;
                
                // Get selected metric
                const metric = document.getElementById('heatmapMetricSelect').value;
                
                // Create data for heatmap
                const heatmapData = currentData.map(item => ({
                    symbol: item.symbol.replace(':USDT', ''),
                    value: item[metric]
                }));
                
                // Sort by value for better visualization
                heatmapData.sort((a, b) => b.value - a.value);
                
                // Get container
                const container = document.getElementById('heatmapContainer');
                container.innerHTML = '';
                
                // Get dimensions
                const containerWidth = container.clientWidth;
                const containerHeight = 600;
                
                // Set up D3
                const margin = { top: 20, right: 20, bottom: 20, left: 20 };
                const width = containerWidth - margin.left - margin.right;
                const height = containerHeight - margin.top - margin.bottom;
                
                // Create SVG
                const svg = d3.select('#heatmapContainer')
                    .append('svg')
                    .attr('width', containerWidth)
                    .attr('height', containerHeight)
                    .append('g')
                    .attr('transform', `translate(${margin.left}, ${margin.top})`);
                
                // Define color scale based on metric
                let colorScale;
                switch(metric) {
                    case 'appeal_score':
                    case 'daily_volatility':
                    case 'atr_pct':
                    case 'bb_squeeze':
                    case 'mean_reversion_score':
                        colorScale = d3.scaleLinear()
                            .domain([0, d3.max(heatmapData, d => d.value)])
                            .range(['#192338', '#00f5d4']);
                        break;
                    case 'rsi':
                        colorScale = d3.scaleLinear()
                            .domain([0, 50, 100])
                            .range(['#f15bb5', '#192338', '#00f5a0']);
                        break;
                    case 'volume_change_pct':
                        colorScale = d3.scaleLinear()
                            .domain([d3.min(heatmapData, d => d.value), 0, d3.max(heatmapData, d => d.value)])
                            .range(['#f15bb5', '#192338', '#00f5a0']);
                        break;
                    default:
                        colorScale = d3.scaleLinear()
                            .domain([0, d3.max(heatmapData, d => d.value)])
                            .range(['#192338', '#00f5d4']);
                }
                
                // Calculate tile size
                const tileSize = Math.floor(Math.sqrt((width * height) / heatmapData.length));
                const columns = Math.floor(width / tileSize);
                const rows = Math.ceil(heatmapData.length / columns);
                
                // Create tiles
                svg.selectAll('rect')
                    .data(heatmapData)
                    .enter()
                    .append('rect')
                    .attr('x', (d, i) => (i % columns) * tileSize)
                    .attr('y', (d, i) => Math.floor(i / columns) * tileSize)
                    .attr('width', tileSize - 2)
                    .attr('height', tileSize - 2)
                    .attr('fill', d => colorScale(d.value))
                    .attr('rx', 4)
                    .attr('ry', 4)
                    .on('mouseover', function(event, d) {
                        // Show tooltip
                        d3.select(this).attr('stroke', '#ffffff').attr('stroke-width', 2);
                        
                        // Create tooltip
                        const tooltip = d3.select('body').append('div')
                            .attr('class', 'heatmap-tooltip')
                            .style('position', 'absolute')
                            .style('background-color', 'rgba(0, 0, 0, 0.8)')
                            .style('color', '#ffffff')
                            .style('padding', '10px')
                            .style('border-radius', '5px')
                            .style('pointer-events', 'none')
                            .style('z-index', 1000)
                            .style('top', `${event.pageY + 10}px`)
                            .style('left', `${event.pageX + 10}px`);
                        
                        // Add content to tooltip
                        tooltip.html(`
                            <div><strong>${d.symbol}</strong></div>
                            <div>${getMetricName(metric)}: ${formatMetricValue(metric, d.value)}</div>
                        `);
                    })
                    .on('mousemove', function(event) {
                        // Move tooltip with mouse
                        d3.select('.heatmap-tooltip')
                            .style('top', `${event.pageY + 10}px`)
                            .style('left', `${event.pageX + 10}px`);
                    })
                    .on('mouseout', function() {
                        // Hide tooltip
                        d3.select(this).attr('stroke', null);
                        d3.select('.heatmap-tooltip').remove();
                    })
                    .on('click', function(event, d) {
                        // Show detailed view
                        const fullSymbol = d.symbol + 'USDT';
                        const coinData = currentData.find(item => item.symbol.includes(d.symbol));
                        if (coinData) {
                            showDetailedAnalysis(d.symbol);
                        }
                    });
                
                // Add labels
                svg.selectAll('text')
                    .data(heatmapData)
                    .enter()
                    .append('text')
                    .attr('x', (d, i) => (i % columns) * tileSize + tileSize / 2)
                    .attr('y', (d, i) => Math.floor(i / columns) * tileSize + tileSize / 2)
                    .attr('text-anchor', 'middle')
                    .attr('dominant-baseline', 'middle')
                    .attr('fill', d => getContrastColor(colorScale(d.value)))
                    .attr('font-size', tileSize / 4)
                    .text(d => d.symbol);
            }
            
            function getMetricName(metric) {
                const names = {
                    'appeal_score': 'Appeal Score',
                    'daily_volatility': 'Volatility %',
                    'atr_pct': 'ATR %',
                    'rsi': 'RSI',
                    'volume_change_pct': 'Volume Change %',
                    'bb_squeeze': 'Bollinger Squeeze',
                    'mean_reversion_score': 'Mean Reversion Score'
                };
                return names[metric] || metric;
            }
            
            function formatMetricValue(metric, value) {
                switch(metric) {
                    case 'appeal_score':
                    case 'mean_reversion_score':
                    case 'bb_squeeze':
                        return (value * 100).toFixed(0) + '%';
                    case 'daily_volatility':
                    case 'atr_pct':
                    case 'volume_change_pct':
                        return value.toFixed(2) + '%';
                    case 'rsi':
                        return value.toFixed(1);
                    default:
                        return value.toFixed(2);
                }
            }
            
            function getContrastColor(hexColor) {
                // Convert hex to RGB
                const r = parseInt(hexColor.slice(1, 3), 16);
                const g = parseInt(hexColor.slice(3, 5), 16);
                const b = parseInt(hexColor.slice(5, 7), 16);
                
                // Calculate luminance
                const luminance = (0.299 * r + 0.587 * g + 0.114 * b) / 255;
                
                // Return black or white based on luminance
                return luminance > 0.5 ? '#000000' : '#ffffff';
            }
            
            function setupPortfolioSimulator() {
                // Add portfolio simulation functionality
            }
            
            function setupRealTimeUpdates() {
                // Set up socket connection for real-time updates
                let socket;
                
                function initWebSocket() {
                    const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
                    const wsUrl = `${protocol}//${window.location.host}/ws`;
                    
                    socket = new WebSocket(wsUrl);
                    
                    socket.onopen = function() {
                        console.log('WebSocket connection established');
                        
                        // Subscribe to volatility updates
                        socket.send(JSON.stringify({
                            type: 'subscribe',
                            channels: ['volatility_updates']
                        }));
                    };
                    
                    socket.onmessage = function(event) {
                        const data = JSON.parse(event.data);
                        
                        if (data.type === 'volatility_update') {
                            // Update data in real-time
                            updateVolatilityData(data.data);
                        }
                    };
                    
                    socket.onclose = function() {
                        console.log('WebSocket connection closed');
                        // Attempt to reconnect
                        setTimeout(initWebSocket, 5000);
                    };
                    
                    socket.onerror = function(error) {
                        console.error('WebSocket error:', error);
                    };
                }
                
                // Initialize WebSocket
                initWebSocket();
            }
            
            function updateVolatilityData(newData) {
                if (!newData || !Array.isArray(newData) || newData.length === 0) return;
                
                // Update current data
                newData.forEach(coin => {
                    const index = currentData.findIndex(item => item.symbol === coin.symbol);
                    if (index !== -1) {
                        currentData[index] = {...currentData[index], ...coin};
                    } else {
                        currentData.push(coin);
                    }
                });
                
                // Update grid if available
                if (gridApi) {
                    gridApi.setRowData(currentData);
                }
                
                // Update active view
                const activeTab = document.querySelector('.mdc-tab--active').id;
                if (activeTab === 'heatmap-tab') {
                    initHeatmap();
                } else if (activeTab === 'metrics-tab') {
                    updateMetricsView();
                } else if (activeTab === 'portfolios-tab') {
                    updatePortfolioView();
                }
            }
        });
    </script>
</body>
</html> 